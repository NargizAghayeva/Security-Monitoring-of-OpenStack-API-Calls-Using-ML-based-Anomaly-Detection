[[local|localrc]]

# ============================================
# OpenStack DevStack Configuration
# Thesis: ML-Based Anomaly Detection
# ============================================

# === Passwords ===
ADMIN_PASSWORD=secret
DATABASE_PASSWORD=$ADMIN_PASSWORD
RABBIT_PASSWORD=$ADMIN_PASSWORD
SERVICE_PASSWORD=$ADMIN_PASSWORD

# === Host Configuration ===
# Auto-detect host IP
HOST_IP=$(ip addr | grep 'state UP' -A2 | tail -n1 | awk '{print $2}' | cut -f1 -d'/')

# === Logging Configuration ===
LOGFILE=/opt/stack/logs/stack.sh.log
VERBOSE=True
LOG_COLOR=True
SCREEN_LOGDIR=/opt/stack/logs

# Enable detailed logging
SYSLOG=True
DEBUG_LIBVIRT=False

# === Core Services ===
# Enable required infrastructure
enable_service rabbit mysql key

# === Keystone Configuration ===
# Identity Service - Primary focus
enable_service keystone

# Keystone token format
KEYSTONE_TOKEN_FORMAT=fernet

# === Minimal Additional Services ===
# Disable compute services (not needed for thesis)
disable_service n-net n-cpu n-api n-crt n-obj n-novnc n-xvnc n-cauth n-api-meta n-cond

# Disable Horizon (can enable later if needed)
disable_service horizon

# Disable Tempest testing framework
disable_service tempest

# Enable minimal Glance (image service) for completeness
enable_service g-api g-reg

# Enable minimal Cinder (volume service)
enable_service c-api c-sch c-vol

# Disable Heat (orchestration)
disable_service heat h-api h-api-cfn h-api-cw h-eng

# Disable Swift (object storage)
disable_service s-proxy s-object s-container s-account

# === Network Configuration ===
# Disable Neutron (using simple networking)
disable_service q-svc q-agt q-dhcp q-l3 q-meta neutron

# === API Configuration ===
# Disable rate limiting for testing
API_RATE_LIMIT=False

# === Repository Configuration ===
GIT_BASE=https://opendev.org
RECLONE=False

# === Keystone Advanced Configuration ===
[[post-config|$KEYSTONE_CONF]]
[DEFAULT]
# Enhanced logging
debug = True
log_file = /var/log/keystone/keystone.log
log_dir = /var/log/keystone

# Log format optimized for parsing
[oslo_log]
logging_default_format_string = %(asctime)s.%(msecs)03d %(process)d %(levelname)s %(name)s [%(request_id)s] %(message)s
logging_debug_format_suffix = from (pid=%(process)d) %(funcName)s %(pathname)s:%(lineno)d
logging_exception_prefix = %(asctime)s.%(msecs)03d %(process)d ERROR %(name)s %(message)s

[eventlet_server]
# Limit workers for resource efficiency
public_workers = 2
admin_workers = 2

[token]
# Token expiration (in seconds)
expiration = 3600
provider = fernet

[fernet_tokens]
# Fernet token keys rotation
key_repository = /etc/keystone/fernet-keys/
max_active_keys = 3

# === Additional Logging for API Calls ===
[[post-config|$KEYSTONE_PASTE_INI]]
[filter:debug]
paste.filter_factory = oslo_middleware.debug:Debug.factory

[pipeline:public_api]
pipeline = cors sizelimit http_proxy_to_wsgi osprofiler url_normalize request_id build_auth_context token_auth json_body ec2_extension public_service

[pipeline:admin_api]
pipeline = cors sizelimit http_proxy_to_wsgi osprofiler url_normalize request_id build_auth_context token_auth json_body ec2_extension admin_service

# === Post-installation Hooks ===
[[post-extra|$TOP_DIR]]
# Ensure log directory exists and has correct permissions
sudo mkdir -p /var/log/keystone
sudo chown stack:stack /var/log/keystone
sudo chmod 755 /var/log/keystone
